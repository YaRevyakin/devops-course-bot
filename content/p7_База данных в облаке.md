---
tags:
  - mod7
---
# –ü—Ä–æ–µ–∫—Ç: –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –æ–±–ª–∞–∫–µ

–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞ ‚Äî —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤—É—é PostgreSQL-–±–∞–∑—É –≤ –æ–±–ª–∞–∫–µ, –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –∫ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é. –≠—Ç–æ –∏–º–∏—Ç–∏—Ä—É–µ—Ç production-—Å—Ü–µ–Ω–∞—Ä–∏–π —Å —É–ø—Ä–∞–≤–ª—è–µ–º–æ–π –∏–ª–∏ self-hosted –ë–î.

## üîß –≠—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

### 1. –í—ã–±–æ—Ä –ø–æ–¥—Ö–æ–¥–∞
- **–í–∞—Ä–∏–∞–Ω—Ç A (Managed)**: –∏—Å–ø–æ–ª—å–∑—É–π managed-—Å–µ—Ä–≤–∏—Å (Yandex Managed PostgreSQL, AWS RDS, GCP Cloud SQL)  
  ‚Üí –ü—Ä–æ—â–µ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã, failover ¬´–∏–∑ –∫–æ—Ä–æ–±–∫–∏¬ª  
- **–í–∞—Ä–∏–∞–Ω—Ç B (Self-hosted)**: —Ä–∞–∑–≤–µ—Ä–Ω–∏ PostgreSQL –Ω–∞ –í–ú —á–µ—Ä–µ–∑ Terraform + Ansible  
  ‚Üí –ë–æ–ª—å—à–µ –∫–æ–Ω—Ç—Ä–æ–ª—è, –Ω–æ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –≤—Å—ë –≤—Ä—É—á–Ω—É—é

> –î–ª—è –æ–±—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è **–í–∞—Ä–∏–∞–Ω—Ç B**, —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏.

---
### 2. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ (Self-hosted –ø—Ä–∏–º–µ—Ä)

#### –ß–µ—Ä–µ–∑ Terraform (Yandex Cloud):
```hcl
resource "yandex_compute_instance" "db-master" {
  name = "pg-master"
  platform_id = "standard-v3"
  zone = "ru-central1-a"
  resources { cores = 2; memory = 4 }
  boot_disk { initialize_params { image_id = "fd8ivq60g5vns9l8d87m" } }
  network_interface { subnet_id = yandex_vpc_subnet.default.id; nat = true }
}

resource "yandex_compute_instance" "db-replica" {
  name = "pg-replica"
  # ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ
}
```
#### –ß–µ—Ä–µ–∑ Ansible (–Ω–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL):
```yaml
- name: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL
  apt:
    name: postgresql
    state: present

- name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å pg_hba.conf –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
  lineinfile:
    path: /etc/postgresql/14/main/pg_hba.conf
    line: 'host replication replicator 192.168.10.0/24 md5'

- name: –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏
  postgresql_user:
    name: replicator
    password: secure_password
    role_attr_flags: REPLICATION
```
### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ (streaming replication)

–ù–∞ **master** (`postgresql.conf`):
```conf
wal_level = replica
max_wal_senders = 3
hot_standby = on
```
–ù–∞ **replica**:
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL
sudo systemctl stop postgresql

# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —Å master
pg_basebackup -h 192.168.10.10 -U replicator -D /var/lib/postgresql/14/main -P -R

# –ó–∞–ø—É—Å—Ç–∏—Ç—å
sudo systemctl start postgresql
```
‚Üí Replica —Ç–µ–ø–µ—Ä—å –≤ —Ä–µ–∂–∏–º–µ **read-only**, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

### 4. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ **master** –¥–ª—è –∑–∞–ø–∏—Å–∏
- –î–ª—è —á—Ç–µ–Ω–∏—è –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **replica** (–µ—Å–ª–∏ –ª–æ–≥–∏–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç)

–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (Python):
```python
# –ó–∞–ø–∏—Å—å
DATABASE_URL = "postgresql://appuser:pass@192.168.10.10/mydb"

# –ß—Ç–µ–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
READ_REPLICA_URL = "postgresql://appuser:pass@192.168.10.20/mydb"
```
> –ò—Å–ø–æ–ª—å–∑—É–π connection pooling (–Ω–∞–ø—Ä–∏–º–µ—Ä, `pgbouncer`) –≤ production.

### 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

- –û—Å—Ç–∞–Ω–æ–≤–∏ master: `sudo systemctl stop postgresql`
- –£–±–µ–¥–∏—Å—å, —á—Ç–æ replica –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ (–≤ read-only)
- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –Ω–∞—Å—Ç—Ä–æ–π **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π failover** —á–µ—Ä–µ–∑ Patroni + etcd

---
## üí° –ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ?

> –≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç:
> 
> - –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ –ë–î –≤ –æ–±–ª–∞–∫–µ
> - –ù–∞—Å—Ç—Ä–æ–π–∫—É —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏
> - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º  
>     ‚Äî –≤—Å—ë, —á—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è production-—Å–∏—Å—Ç–µ–º—ã.

## ‚ö†Ô∏è –°–æ–≤–µ—Ç—ã

- –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π **—Å–∏–ª—å–Ω—ã–µ –ø–∞—Ä–æ–ª–∏** –∏ **–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏**
- –í–∫–ª—é—á–∏ **–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤**
- –ù–∞—Å—Ç—Ä–æ–π **—Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ** (–¥–∞–∂–µ –ø—Ä–∏ —Ä–µ–ø–ª–∏–∫–∞—Ü–∏–∏!)
- –î–ª—è production ‚Äî —Ä–∞—Å—Å–º–æ—Ç—Ä–∏ **Patroni** –∏–ª–∏ managed-—Å–µ—Ä–≤–∏—Å

---
### –°–Ω–æ—Å–∫–∏

[^replication]: Streaming replication –≤ PostgreSQL –ø–µ—Ä–µ–¥–∞—ë—Ç WAL-–∑–∞–ø–∏—Å–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏. Replica –º–æ–∂–µ—Ç –æ—Ç—Å—Ç–∞–≤–∞—Ç—å –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ (asynchronous).